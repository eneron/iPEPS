function [ epsilon_env ] =...
    convergence_CTM(tensor_C_old,tensor_T_old,tensor_C,tensor_T,...
    tensor_A,tensor_B,varargin)
if nargin==6
    PHYS_DIM=size(tensor_A,1);
    
%     tensor_a=ncon({tensor_A,conj(tensor_A)},...
%         {[1,-1,-2,-3,-4],[1,-5,-6,-7,-8]});
%     tensor_b=ncon({tensor_B,conj(tensor_B)},...
%         {[1,-1,-2,-3,-4],[1,-5,-6,-7,-8]});
    
    % environment tensor E
%     tensor_Env=ncon({tensor_C{1},tensor_C{2},tensor_C{3},tensor_C{4},...
%         tensor_T{1},tensor_T{2},tensor_T{3},tensor_T{4},...
%         tensor_T{5},tensor_T{6},tensor_T{7},tensor_T{8},...
%         tensor_b,tensor_a},...
%         {[1,2],[3,4],[5,6],[7,8],...
%         [-1,-2,2,20],[-3,-4,20,3],[-5,-6,4,21],[13,14,21,5],...
%         [15,16,6,17],[11,12,17,7],[9,10,8,22],[-11,-12,22,1],...
%         [-9,9,11,18,-10,10,12,19],[-7,18,15,13,-8,19,16,14]});
    tensor_Env=tensor_Env_right(tensor_A,tensor_B,tensor_C,tensor_T);
    
    tensor_rho_AB=...
        ncon({tensor_Env,tensor_A,conj(tensor_A),tensor_B,conj(tensor_B)},...
        {[1,2,3,4,5,6,9,10,11,12,13,14],...
        [-1,1,3,5,7],[-2,2,4,6,8],[-3,9,7,11,13],[-4,10,8,12,14]});
    tensor_rho_AB=...
        reshape(permute(tensor_rho_AB,[1,3,2,4]),[PHYS_DIM^2,PHYS_DIM^2]);
    tensor_rho_AB=tensor_rho_AB/trace(tensor_rho_AB);
    
    % environment tensor E
%     tensor_Env_old=ncon({tensor_C_old{1},tensor_C_old{2},tensor_C_old{3},tensor_C_old{4},...
%         tensor_T_old{1},tensor_T_old{2},tensor_T_old{3},tensor_T_old{4},...
%         tensor_T_old{5},tensor_T_old{6},tensor_T_old{7},tensor_T_old{8},...
%         tensor_b,tensor_a},...
%         {[1,2],[3,4],[5,6],[7,8],...
%         [-1,-2,2,20],[-3,-4,20,3],[-5,-6,4,21],[13,14,21,5],...
%         [15,16,6,17],[11,12,17,7],[9,10,8,22],[-11,-12,22,1],...
%         [-9,9,11,18,-10,10,12,19],[-7,18,15,13,-8,19,16,14]});
    tensor_Env_old=tensor_Env_right(tensor_A,tensor_B,tensor_C_old,tensor_T_old);
    
    tensor_rho_AB_old=...
        ncon({tensor_Env_old,tensor_A,conj(tensor_A),tensor_B,conj(tensor_B)},...
        {[1,2,3,4,5,6,9,10,11,12,13,14],...
        [-1,1,3,5,7],[-2,2,4,6,8],[-3,9,7,11,13],[-4,10,8,12,14]});
    tensor_rho_AB_old=...
        reshape(permute(tensor_rho_AB_old,[1,3,2,4]),[PHYS_DIM^2,PHYS_DIM^2]);
    tensor_rho_AB_old=tensor_rho_AB_old/trace(tensor_rho_AB_old);
    
    epsilon_env=sum(abs(tensor_rho_AB(:)-tensor_rho_AB_old(:)));
    
else
    epsilon_env=...
        norm(svd(tensor_C{1})-svd(tensor_C_old{1}))+...
        norm(svd(tensor_C{2})-svd(tensor_C_old{2}))+...
        norm(svd(tensor_C{3})-svd(tensor_C_old{3}))+...
        norm(svd(tensor_C{4})-svd(tensor_C_old{4}));
end

